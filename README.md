# Сервис для работы с ПВЗ

## Описание проекта

На ПВЗ несколько раз в день привозят новые товары, которые были заказаны через Авито. Прежде чем их отдавать заказчику, необходимо сначала проверить и внести информацию в базу. Из-за того, что ПВЗ много, а товаров ещё больше, нужно реализовать механизм, позволяющий в разрезе каждого ПВЗ увидеть, сколько раз в день к ним приезжали товары на приёмку и какие товары были получены.
Полное техническое задание и swagger документация находиться в директории docks 



Проект реализует REST API с хранением данных в PostgreSQL. Дополнительно реализован gRPC endpoint для получения списка ПВЗ.

На текущий момент в проекте реализовано:
1. HTTP сервер с REST API
2. gRPC сервер для получения списка ПВЗ
3. Аутентификация и авторизация через JWT-токен
4. Комплексное тестирование:
   - Unit-тесты
   - Интеграционные тесты
5)  Мониторинг через Prometheus:
   #### Технические метрики:
   - Количество запросов
   - Время ответа
   #### Бизнес-метрики:
   - Количество созданных ПВЗ
   - Количество созданных приёмок заказов
   - Количество добавленных товаров
   
6) Настроена сборка и запуск и unit тестирование проекта через docker-compose.


## Структура проекта
```
service-podof/
├───api                                    # API контракты
│   └───proto                             # Protocol Buffers определения
│       └───v1                            # Версия 1 API
│           └───pvz.proto                 # Определение сервиса PVZ
├───cmd                                   # Точки входа в приложение
│   ├───service-podof                     # Основной сервис
│   │   ├───http-server                   # HTTP сервер
│   │   └───grpc-server                   # gRPC сервер
├───deploy                                # Файлы для развертывания
│   └───docker                            # Docker файлы
│       ├───Dockerfile.service-podof      # Dockerfile для основного сервиса
│       ├───Dockerfile.service-podof      # Dockerfile для gRPC сервиса
│       ├───Dockerfile.migrations         # Dockerfile для миграций
│       └───Dockerfile.test               # Dockerfile для тестов
├───docs                                  # Документация к проекту     
├───grafana                               # Настройки графаны (на текущий момент grafana не настроена)
├───internal                              # Внутренний код приложения
│   ├───app                               # Инициализация приложения
|   │   ├───grpc                          # Инициализация gRPC приложения   
|   │   └───router                        # Инициализация http приложения  
│   ├───config                            # Конфигурация приложения
│   ├───controller                        # Контроллеры
│   │   ├───http                          # HTTP контроллеры
│   │   │   ├───handler                   # Обработчики HTTP запросов
│   │   │   └───middleware                # HTTP middleware
│   │   └───grpc                          # gRPC контроллеры
│   ├───entity                            # Бизнес-сущности
│   ├───metrics                           # Настройка prometheus
│   ├───repository                        # Слой работы с БД
│   │   └───postgres                      # Реализация для PostgreSQL
│   └───service                           # Бизнес-логика
├───migrations                            # SQL миграции
├───pkg                                   # Публичные пакеты
│   ├───errorsx                           # Кастомные ошибки
│   ├───jwttoken                          # Работа с JWT
│   └───pvz                               # Сгенерированный код из proto
│       └───v1                            # Версия 1
├───prometheus                            # конфигурация prometheus                         
├───test                                  # Тесты
│   └───integration                       # Интеграционные тесты
├───.env                                  # Переменные окружения
├───.gitignore                           
├───docker-compose.yaml                   # Композиция Docker сервисов
├───go.mod                               
└───README.md  
```

## Инструкция по запуску кода локально

### Предварительные условия

- Go версии 1.23 и выше
- Установленный docker-compose
### Настройка .env

Создайте локальные переменные окружения (файл `.env`) в корне проекта со следующим содержимым:

```
POSTGRES_DB=podof
PORT_LOCAL=5432
POSTGRES_PORT=5432
POSTGRES_USER=postgres
POSTGRES_PASSWORD=123456
PG_DSN=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:${POSTGRES_PORT}/${POSTGRES_DB}?sslmode=disable

HOST_PORT=8080
PORT=8080
HOST=0.0.0.0

GRPC_PORT=3000
```

### Запуск приложения

1. Установите зависимости командой:

```sh
go mod download
```
2. Создание и инициализация базы данных:

```sh
docker-compose up db migrations
```

2. Запустите приложение:

```sh
$ go run cmd/service-podof/http-server/main.go 
$ go run cmd/service-podof/grpc-server/main.go 
```


Взаимодействие с приложением по HTTP будет доступно по адресу http://0.0.0.0:8080 
Взаимодействие с приложением по gRPC будет доступно по адресу http://0.0.0.0:3000 

## Cборка и запуск проекта через docker-compose (предпочтительный способ)

1. Выполните сборку Docker образа командой:

```sh
docker-compose up
```

## Тестирование сервера 

1. Запустите тесты командой:

```sh
go test ./...
```

## Вопросы и решения, возникшие в процессе разработки:

1. **Несоответствие в документации по ролям**
   - Проблема: Расхождение между спецификацией (клиент/модератор) и требованиями (сотрудник ПВЗ)
   - Решение: 
     - Добавлена роль "сотрудник ПВЗ" (pvz_employee)
     - Определены четкие права доступа для каждой роли:
       * Клиент: просмотр ПВЗ 
       * Модератор: управление ПВЗ
       * Сотрудник ПВЗ: управление приемкой и товарами

2. **Оптимизация структуры ответа API**
   - Проблема: Неоптимальная структура данных в ответе GET /pvz
   - Решение:
     - Реорганизована структура ответа для лучшей иерархии данных
     - Товары теперь вложены в структуру приемки, что улучшает читаемость и логическую связность данных

3. **Генерация кода по OpenAPI/Swagger**
   - Проблема: Сгенерированный код создавал отдельный сервер для каждого эндпоинта из-за отсутствия тегов в документации
   - Решение:
     - Принято решение использовать ручную реализацию эндпоинтов и DTO



## Планируемые улучшения

### Архитектурные:
- Единая точка входа для HTTP и gRPC серверов
- Оптимизация SQL запросов
- Внедрение Redis для кэширования

### Инфраструктурные:
- Настройка балансировщика нагрузки (nginx)
- Конфигурация Grafana
- Масштабирование приложения

### Функциональные:
- Расширение системы разрешений
- Оптимизация работы с пользователями
- Улучшение производительности запросов


#### Благодарность
## Спасибо за внимание
